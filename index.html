<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Dermatology Shop</title>
<link rel="icon" href="images/favicon.ico">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{--ink:#0f172a;--muted:#64748b;--bd:#e5e7eb;--bg:#ffffff;--brand:#10b981;--chip:#f3f4f6;--danger:#ef4444;}
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Arial,sans-serif}
  a{color:inherit}
  /* Header */
  header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--bd);z-index:40}
  .wrap{max-width:1100px;margin:0 auto;padding:12px}
  .row{display:flex;align-items:center;gap:12px}
  .grow{flex:1}
  .brand{display:flex;align-items:center;gap:10px}
  .brand img{width:36px;height:36px;border-radius:8px;object-fit:cover}
  h1{font-size:20px;margin:0}
  select,input,button,textarea{font:inherit;padding:10px;border:1px solid var(--bd);border-radius:10px;background:#fff}
  input::placeholder,textarea::placeholder{color:#94a3b8}
  button{cursor:pointer}
  .btn{background:var(--brand);color:#fff;border:none}
  .btn.secondary{background:#fff;color:var(--ink);border:1px solid var(--ink)}
  /* Toolbar */
  .toolbar{gap:10px;margin-top:8px}
  .search{flex:1}
  /* Layout */
  main{max-width:1100px;margin:0 auto;padding:12px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
  /* Cards */
  .card{border:1px solid var(--bd);border-radius:14px;padding:12px;display:flex;flex-direction:column;gap:10px;position:relative;background:#fff}
  .card:hover{box-shadow:0 6px 24px rgba(0,0,0,.06)}
  .badge{position:absolute;top:8px;left:8px;background:#111;color:#fff;border-radius:999px;font-size:12px;padding:4px 8px}
  .price{font-weight:600}
  .sku{color:var(--muted);font-size:12px}
  .img{width:100%;height:170px;border:1px solid var(--bd);border-radius:10px;object-fit:contain;background:#fff}
  .stepper{display:flex;align-items:center;gap:6px}
  .stepper button{width:36px}
  .stepper input{width:70px;text-align:center}
  /* FAB + Drawer */
  .fab{position:fixed;right:16px;bottom:16px;border-radius:999px;padding:12px 16px;background:#111;color:#fff;border:none;z-index:50;display:none}
  .drawer{position:fixed;right:0;top:0;height:100%;width:380px;max-width:92vw;background:#fff;box-shadow:-2px 0 26px rgba(0,0,0,.12);transform:translateX(100%);transition:transform .25s ease;z-index:60;display:flex;flex-direction:column}
  .drawer.open{transform:translateX(0)}
  .drawer header{border-bottom:1px solid var(--bd)}
  .drawer .body{padding:12px;overflow:auto;flex:1}
  .drawer .foot{padding:12px;border-top:1px solid var(--bd);display:flex;gap:10px}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--bd);padding:8px;text-align:left}
  tfoot td{font-weight:600}
  .rm{color:#111;border:1px solid #111;background:#fff;border-radius:8px;padding:4px 8px;cursor:pointer}
  /* Screens */
  .screen{display:none}
  .two{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  @media (max-width:800px){ .two{grid-template-columns:1fr} }
  .error{border-color:var(--danger)!important}
  .msg{font-size:12px;color:var(--danger);margin-top:6px}
  /* Toast */
  .toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#111;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;pointer-events:none;transition:opacity .25s}
  .toast.show{opacity:1}
  /* Footer */
  footer{max-width:1100px;margin:20px auto;padding:0 12px 24px;color:var(--muted);font-size:12px}
</style>
</head>
<body>

<header>
  <div class="wrap">
    <div class="row">
      <div class="brand">
        <img src="images/logo.png" alt="Clinic logo" onerror="this.style.display='none'">
        <h1>Dermatology Shop</h1>
      </div>
      <div class="grow"></div>
      <button class="btn secondary" onclick="go('#/shop')">Shop</button>
      <button id="cartBadge" class="btn" onclick="openDrawer()" style="display:none">Cart • <span id="cartCount">0</span></button>
    </div>
    <div class="row toolbar">
      <label>Category
        <select id="category"></select>
      </label>
      <input id="search" class="search" placeholder="Search products">
    </div>
  </div>
</header>

<main>
  <!-- Screen: Shop -->
  <section id="shop" class="screen">
    <div id="items" class="grid"></div>
  </section>

  <!-- Screen: Checkout -->
  <section id="checkout" class="screen">
    <h2>Checkout</h2>
    <div class="two">
      <form id="custForm" novalidate>
        <label>Name<input id="name" autocomplete="name" required></label>
        <div id="err_name" class="msg" style="display:none">Enter your name</div>
        <label>Phone<input id="phone" autocomplete="tel" required></label>
        <div id="err_phone" class="msg" style="display:none">Enter a valid phone</div>
        <label>Email<input id="email" type="email" autocomplete="email" required></label>
        <div id="err_email" class="msg" style="display:none">Enter a valid email</div>
        <label>Address<input id="addr" autocomplete="street-address" required></label>
        <div id="err_addr" class="msg" style="display:none">Enter your address</div>
        <label>Notes (optional)<textarea id="notes" rows="3" placeholder="Delivery instructions"></textarea></label>
        <button type="button" id="btnPlace" class="btn">Place order</button>
        <button type="button" class="btn secondary" onclick="go('#/shop')">Back to shop</button>
      </form>
      <div>
        <h3>Order summary</h3>
        <div id="summary"></div>
      </div>
    </div>
  </section>

  <!-- Screen: Confirmation -->
  <section id="confirm" class="screen">
    <h2>Order placed</h2>
    <p id="confirmMsg"></p>
    <div id="confirmTable"></div>
    <p style="color:var(--muted)">A receipt has been emailed. For questions call the clinic.</p>
    <button class="btn secondary" onclick="go('#/shop'); loadInventory()">Continue shopping</button>
  </section>
</main>

<footer>
  <div class="two">
    <div>
      <h3>About</h3>
      Board-certified dermatologist. Clinic hours: Sun–Fri 10:00–17:00.
    </div>
    <div>
      <h3>Contact</h3>
      Phone: <a href="tel:01-XXXXXXX">01-XXXXXXX</a><br>
      Email: <a href="mailto:clinic@example.com">clinic@example.com</a><br>
      Address: Street, City
    </div>
  </div>
  <p style="margin-top:16px">Privacy: Your name, phone, email, and address are used only to fulfill your order. We don’t sell or share your data.</p>
</footer>

<!-- Cart FAB and Drawer -->
<button id="fabCart" class="fab" onclick="openDrawer()">Cart • <span id="fabN">0</span></button>
<aside id="drawer" class="drawer" aria-label="Cart">
  <header class="wrap row">
    <h3 style="margin:0">Your Cart</h3>
    <div class="grow"></div>
    <button class="btn secondary" onclick="closeDrawer()">Close</button>
  </header>
  <div class="body">
    <div id="drawerBody"></div>
  </div>
  <div class="foot">
    <button class="btn" style="flex:1" onclick="goCheckout()">Checkout</button>
    <button class="btn secondary" style="flex:1" onclick="clearCart()">Clear</button>
  </div>
</aside>

<div id="toast" class="toast">Added to cart</div>

<script>
/* ===== CONFIG ===== */
const API = 'https://script.google.com/macros/s/AKfycbzzNZWZNol8M63BDYoEUKAwIWhbJ5d3p0nNj-txfokv0GQ6SALNjRb6X324ASzMfvKN/exec'; // ends with /exec
const CURRENCY = 'NPR';

/* ===== STATE ===== */
let INVENTORY = [];
const cart = new Map(); // sku -> {sku,name,price,qty}

/* ===== UTIL ===== */
const money = n => `${CURRENCY} ${Number(n).toFixed(2)}`;
const esc = s => String(s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
function toast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1400); }

/* ===== ROUTER ===== */
function go(route){ location.hash = route; renderRoute(); }
window.addEventListener('hashchange', renderRoute);
function renderRoute(){
  const r = location.hash || '#/shop';
  show('shop', r==='#/shop');
  show('checkout', r==='#/checkout');
  show('confirm', r==='#/confirm');
  if(r==='#/checkout') renderCheckout();
}
function show(id, v){ document.getElementById(id).style.display = v?'block':'none'; }

/* ===== INVENTORY ===== */
async function loadInventory(){
  const res = await fetch(API + '?action=inventory');
  INVENTORY = await res.json();
  buildFilters(INVENTORY);
  renderProducts();
}
function buildFilters(items){
  const sel = document.getElementById('category');
  sel.innerHTML = '';
  const opts = ['All', ...[...new Set(items.map(x=>x.category).filter(Boolean))].sort()];
  opts.forEach((name,i)=>{
    const o = document.createElement('option');
    o.value = i===0 ? '' : name;
    o.textContent = name;
    sel.appendChild(o);
  });
}
function filteredInventory(){
  const cat = document.getElementById('category').value.trim().toLowerCase();
  const q = document.getElementById('search').value.trim().toLowerCase();
  return INVENTORY.filter(it=>{
    const okCat = !cat || (it.category||'').toLowerCase() === cat;
    const okQ = !q || it.name.toLowerCase().includes(q) || it.sku.toLowerCase().includes(q);
    return okCat && okQ;
  });
}
function renderProducts(){
  const box = document.getElementById('items');
  box.innerHTML = '';
  const items = filteredInventory();
  if(items.length===0){ box.innerHTML = '<p style="color:var(--muted)">No products match your filter.</p>'; return; }
  items.forEach(it=>{
    const out = Number(it.stock)<=0;
    const c = document.createElement('div'); c.className='card';
    c.innerHTML = `
      ${out?'<div class="badge">Out of stock</div>':''}
      <img class="img" loading="lazy" src="${esc(it.image||'')}" alt="${esc(it.name)}" onerror="this.style.display='none'">
      <div class="row"><b>${esc(it.name)}</b><span class="price">${money(it.price)}</span></div>
      <div class="row"><span class="sku">SKU ${esc(it.sku)}</span><span class="sku">${esc(it.category||'')}</span></div>
      <div class="row">
        <div class="stepper">
          <button class="minus" data-sku="${it.sku}" ${out?'disabled':''}>−</button>
          <input id="q_${it.sku}" type="number" value="1" min="1" max="${it.stock}" ${out?'disabled':''}>
          <button class="plus" data-sku="${it.sku}" ${out?'disabled':''}>+</button>
        </div>
        <button class="btn add" data-sku="${it.sku}" ${out?'disabled':''}>Add to cart</button>
      </div>`;
    c.querySelector('.minus')?.addEventListener('click',()=>step(it.sku,-1,it.stock));
    c.querySelector('.plus')?.addEventListener('click',()=>step(it.sku,1,it.stock));
    c.querySelector('.add')?.addEventListener('click',()=>addToCart(it));
    box.appendChild(c);
  });
}
function step(sku,delta,max){
  const el = document.getElementById('q_'+sku);
  const v = Math.max(1, Math.min((Number(el.value)||1)+delta, Number(max)||999));
  el.value = v;
}
function addToCart(it){
  const q = Math.max(1, Number(document.getElementById('q_'+it.sku)?.value||1));
  const prev = cart.get(it.sku)?.qty || 0;
  cart.set(it.sku, { sku: it.sku, name: it.name, price: it.price, qty: prev+q });
  syncCartBadges();
  toast('Added to cart');
}

/* ===== CART UI ===== */
function syncCartBadges(){
  const n = [...cart.values()].reduce((a,b)=>a+b.qty,0);
  const badge = document.getElementById('cartBadge');
  const fab = document.getElementById('fabCart');
  document.getElementById('cartCount').textContent = n;
  document.getElementById('fabN').textContent = n;
  badge.style.display = n? 'inline-block':'none';
  fab.style.display = n? 'inline-block':'none';
  renderDrawer();
}
function renderDrawer(){
  const body = document.getElementById('drawerBody');
  if(cart.size===0){ body.innerHTML = '<p style="color:var(--muted)">Your cart is empty.</p>'; return; }
  let rows = '<table><thead><tr><th>SKU</th><th>Qty</th><th style="text-align:right">Line</th><th></th></tr></thead><tbody>';
  let total = 0;
  for(const it of cart.values()){
    const line = it.qty*it.price; total+=line;
    rows += `<tr>
      <td>${esc(it.sku)}</td>
      <td>
        <input type="number" min="1" value="${it.qty}" data-sku="${esc(it.sku)}" class="qty" style="width:70px">
      </td>
      <td style="text-align:right">${money(line)}</td>
      <td style="text-align:right"><button class="rm" data-sku="${esc(it.sku)}">Remove</button></td>
    </tr>`;
  }
  rows += `</tbody><tfoot><tr><td colspan="2" style="text-align:right">Subtotal</td><td style="text-align:right">${money(total)}</td><td></td></tr></tfoot></table>`;
  body.innerHTML = rows;
  body.querySelectorAll('.qty').forEach(inp=>{
    inp.onchange = ()=>{ const s=inp.dataset.sku; const it=cart.get(s); it.qty=Math.max(1,Number(inp.value||1)); cart.set(s,it); syncCartBadges(); };
  });
  body.querySelectorAll('.rm').forEach(btn=>{
    btn.onclick=()=>{ cart.delete(btn.dataset.sku); syncCartBadges(); };
  });
}
function openDrawer(){ document.getElementById('drawer').classList.add('open'); }
function closeDrawer(){ document.getElementById('drawer').classList.remove('open'); }
function clearCart(){ cart.clear(); syncCartBadges(); }

/* ===== CHECKOUT ===== */
function goCheckout(){
  closeDrawer();
  if(cart.size===0){ toast('Cart is empty'); return; }
  go('#/checkout');
}
function renderCheckout(){
  // summary
  let rows = '<table><thead><tr><th>SKU</th><th>Name</th><th style="text-align:right">Qty</th><th style="text-align:right">Line</th></tr></thead><tbody>';
  let total=0;
  for(const it of cart.values()){
    const line=it.qty*it.price; total+=line;
    rows += `<tr><td>${esc(it.sku)}</td><td>${esc(it.name)}</td><td style="text-align:right">${it.qty}</td><td style="text-align:right">${money(line)}</td></tr>`;
  }
  rows += `</tbody><tfoot><tr><td colspan="3" style="text-align:right">Subtotal</td><td style="text-align:right">${money(total)}</td></tr></tfoot></table>`;
  document.getElementById('summary').innerHTML = rows;
}
function validateForm(){
  const f = id => document.getElementById(id);
  const errs = {name:!f('name').value.trim(), addr:!f('addr').value.trim(),
                email:!/^\S+@\S+\.\S+$/.test(f('email').value.trim()),
                phone:!/^[0-9+()\-\s]{8,}$/.test(f('phone').value.trim())};
  ['name','addr','email','phone'].forEach(k=>{
    f(k).classList.toggle('error', !!errs[k]);
    document.getElementById('err_'+k)?.style.setProperty('display', errs[k]?'block':'none');
  });
  return !Object.values(errs).some(Boolean);
}
async function placeOrder(){
  if(cart.size===0){ toast('Cart is empty'); return; }
  if(!validateForm()) return;

  const customer = {
    name: document.getElementById('name').value.trim(),
    phone: document.getElementById('phone').value.trim(),
    email: document.getElementById('email').value.trim(),
    address: document.getElementById('addr').value.trim(),
    notes: document.getElementById('notes').value.trim() // optional; backend may ignore
  };
  const items = [...cart.values()].map(i=>({sku:i.sku, qty:i.qty}));

  const res = await fetch(API, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ action:'order', payload:{ customer, items } })
  });
  const data = await res.json();
  if(!data?.ok){ alert('Order failed: ' + (data?.error||'Unknown error')); return; }

  // confirmation
  document.getElementById('confirmMsg').textContent =
    `Order ${data.orderId} placed successfully. Total ${CURRENCY} ${Number(data.subtotal).toFixed(2)}.`;
  // reuse checkout summary for confirm
  document.getElementById('confirmTable').innerHTML = document.getElementById('summary').innerHTML;

  cart.clear(); syncCartBadges();
  // reset form
  ['name','phone','email','addr','notes'].forEach(id=>document.getElementById(id).value='');
  go('#/confirm');
}

/* ===== EVENTS ===== */
document.getElementById('category').addEventListener('change', renderProducts);
document.getElementById('search').addEventListener('input', renderProducts);
document.getElementById('btnPlace').addEventListener('click', placeOrder);

/* ===== INIT ===== */
loadInventory().then(()=>{ go('#/shop'); });
</script>
</body>
</html>
