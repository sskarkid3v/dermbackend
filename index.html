<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Dermatology Shop</title>
<link rel="icon" href="images/favicon.ico">
<style>
  :root { --brand:#0b6; --ink:#111; --muted:#666; --bd:#e5e7eb; --bg:#ffffff; --chip:#f3f4f6; }
  * { box-sizing: border-box; }
  body { margin:16px; font-family: system-ui, Arial, sans-serif; color: var(--ink); background: var(--bg); }
  header { display:flex; align-items:center; gap:12px; margin-bottom:12px; }
  header img { width:40px; height:40px; border-radius:8px; object-fit:cover; }
  header h1 { font-size:24px; margin:0; }
  .toolbar { display:flex; gap:12px; align-items:center; margin: 8px 0 16px; }
  select, input, textarea, button { padding:10px; border:1px solid var(--bd); border-radius:10px; font:inherit; }
  button { background: var(--brand); color: #fff; border: 0; cursor: pointer; }
  button.secondary { background:#fff; color: var(--ink); border:1px solid var(--ink); }
  .grid { display:grid; grid-template-columns: repeat(auto-fill,minmax(220px,1fr)); gap:12px; }
  .card { border:1px solid var(--bd); border-radius:14px; padding:12px; display:flex; flex-direction:column; gap:8px; position:relative; }
  .badge { position:absolute; top:8px; left:8px; background:#222; color:#fff; padding:4px 8px; font-size:12px; border-radius:999px; }
  .price { font-weight:600; }
  img.item { width:100%; height:150px; object-fit:contain; background:#fff; border:1px solid var(--bd); border-radius:10px; }
  .row { display:flex; justify-content:space-between; align-items:center; gap:8px; }
  .muted { color: var(--muted); font-size:12px; }
  .two { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
  @media (max-width:720px){ .two { grid-template-columns:1fr; } }
  .section { margin-top:16px; }
  .error { border-color: #e11d48 !important; }
  footer { margin-top:24px; font-size:12px; color:var(--muted); }
  .hidden { display:none; }
  .pill { background: var(--chip); padding:6px 10px; border-radius:999px; font-size:12px; }
</style>
</head>
<body>

<header>
  <img src="images/logo.png" alt="Clinic Logo" onerror="this.style.display='none'">
  <h1>Dermatology Shop</h1>
  <span id="cartPill" class="pill" style="margin-left:auto;display:none"></span>
</header>

<div class="toolbar">
  <label>Category
    <select id="category">
      <option value="">All</option>
    </select>
  </label>
  <input id="search" placeholder="Search products">
</div>

<div class="grid" id="items"></div>

<div class="section">
  <h2>Customer</h2>
  <div class="two">
    <input id="name" placeholder="Full name" autocomplete="name">
    <input id="phone" placeholder="Phone" autocomplete="tel">
    <input id="email" type="email" placeholder="Email" autocomplete="email">
    <input id="addr" placeholder="Address">
  </div>
</div>

<div class="section" id="cartBox" style="display:none">
  <h2>Cart</h2>
  <div id="cartTable"></div>
  <div class="two">
    <button id="placeOrder">Place order</button>
    <button class="secondary" id="clearCart">Clear cart</button>
  </div>
</div>

<!-- Confirmation page -->
<div class="section hidden" id="confirm">
  <h2>Order placed</h2>
  <p id="confirmMsg"></p>
  <div id="confirmTable"></div>
  <p class="muted">A receipt has been emailed. For questions call the clinic.</p>
  <button id="newOrder" class="secondary">Start a new order</button>
</div>

<hr class="section">

<section class="two">
  <div>
    <h3>About</h3>
    <p>Board-certified dermatologist. Clinic hours: Sun–Fri 10:00–17:00.</p>
  </div>
  <div>
    <h3>Contact</h3>
    <p>Phone: 01-XXXXXXX<br>Email: clinic@example.com<br>Address: Street, City</p>
  </div>
</section>
<footer>
  Privacy: Your name, phone, email, and address are used only to fulfill your order. We don’t sell or share your data.
</footer>

<script>
const API = 'https://script.google.com/macros/s/AKfycbzzNZWZNol8M63BDYoEUKAwIWhbJ5d3p0nNj-txfokv0GQ6SALNjRb6X324ASzMfvKN/exec'; // ends with /exec
let INVENTORY = [];
const cart = new Map(); // sku -> {sku,name,price,qty}

function money(n){ return 'NPR ' + Number(n).toFixed(2); }
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

async function loadInventory(){
  const res = await fetch(API + '?action=inventory');
  INVENTORY = await res.json();
  buildCategoryFilter(INVENTORY);
  renderProducts();
}

function buildCategoryFilter(items){
  const sel = document.getElementById('category');
  const cats = [...new Set(items.map(x => x.category).filter(Boolean))].sort();
  cats.forEach(c => {
    const o = document.createElement('option'); o.value = c; o.textContent = c;
    sel.appendChild(o);
  });
}

function filteredInventory(){
  const cat = document.getElementById('category').value.trim().toLowerCase();
  const q = document.getElementById('search').value.trim().toLowerCase();
  return INVENTORY.filter(it=>{
    const okCat = !cat || (it.category||'').toLowerCase() === cat;
    const okQ = !q || it.name.toLowerCase().includes(q) || it.sku.toLowerCase().includes(q);
    return okCat && okQ;
  });
}

function renderProducts(){
  const box = document.getElementById('items');
  box.innerHTML = '';
  filteredInventory().forEach(it=>{
    const c = document.createElement('div'); c.className = 'card';
    const out = Number(it.stock) <= 0;
    c.innerHTML = `
      ${out ? '<div class="badge">Out of stock</div>' : ''}
      <img class="item" src="${escapeHtml(it.image||'')}" alt="${escapeHtml(it.name)}" onerror="this.style.display='none'">
      <div class="row"><b>${escapeHtml(it.name)}</b><span class="price">${money(it.price)}</span></div>
      <div class="row muted"><span>SKU ${escapeHtml(it.sku)}</span><span>${escapeHtml(it.category||'')}</span></div>
      <div class="row">
        <input type="number" min="1" max="${it.stock}" value="1" id="q_${it.sku}" ${out?'disabled':''}>
        <button data-sku="${it.sku}" ${out?'disabled':''}>Add</button>
      </div>`;
    c.querySelector('button')?.addEventListener('click', ()=>{
      const q = Math.max(1, Math.min(Number(document.getElementById('q_'+it.sku).value||1), Number(it.stock)));
      const prev = cart.get(it.sku)?.qty || 0;
      cart.set(it.sku, { sku: it.sku, name: it.name, price: it.price, qty: prev + q });
      renderCart();
    });
    box.appendChild(c);
  });
}

function renderCart(){
  const cartBox = document.getElementById('cartBox');
  const pill = document.getElementById('cartPill');
  const n = [...cart.values()].reduce((a,b)=>a+b.qty,0);
  pill.style.display = n? 'inline-block':'none';
  pill.textContent = `Cart • ${n}`;

  if(cart.size === 0){
    cartBox.style.display = 'none';
    document.getElementById('cartTable').innerHTML = '';
    return;
  }
  cartBox.style.display = 'block';
  let rows = ''; let total = 0;
  for(const item of cart.values()){
    const line = item.qty * item.price; total += line;
    rows += `
      <tr>
        <td>${escapeHtml(item.sku)}</td>
        <td>${escapeHtml(item.name)}</td>
        <td style="text-align:right">${money(item.price)}</td>
        <td style="text-align:right"><input type="number" min="1" value="${item.qty}" data-sku="${item.sku}" class="qty"></td>
        <td style="text-align:right">${money(line)}</td>
        <td style="text-align:right"><button class="secondary rm" data-sku="${item.sku}">Remove</button></td>
      </tr>`;
  }
  document.getElementById('cartTable').innerHTML = `
    <table>
      <thead><tr><th>SKU</th><th>Name</th><th>Price</th><th>Qty</th><th>Line</th><th></th></tr></thead>
      <tbody>${rows}</tbody>
      <tfoot><tr><td colspan="4" style="text-align:right">Subtotal</td><td style="text-align:right">${money(total)}</td><td></td></tr></tfoot>
    </table>`;
  document.querySelectorAll('.qty').forEach(inp=>{
    inp.onchange = () => {
      const sku = inp.getAttribute('data-sku');
      const it = cart.get(sku);
      it.qty = Math.max(1, Number(inp.value||1));
      cart.set(sku, it);
      renderCart();
    };
  });
  document.querySelectorAll('.rm').forEach(btn=>{
    btn.onclick = () => { cart.delete(btn.getAttribute('data-sku')); renderCart(); };
  });
}

function validateForm(){
  const f = id => document.getElementById(id);
  const fields = ['name','phone','email','addr'];
  let ok = true;
  fields.forEach(id => f(id).classList.remove('error'));
  if(!/^\S+@\S+\.\S+$/.test(f('email').value.trim())){ f('email').classList.add('error'); ok=false; }
  if(!/^[0-9+()\-\s]{8,}$/.test(f('phone').value.trim())){ f('phone').classList.add('error'); ok=false; }
  if(!f('name').value.trim()){ f('name').classList.add('error'); ok=false; }
  if(!f('addr').value.trim()){ f('addr').classList.add('error'); ok=false; }
  return ok;
}

async function placeOrder(){
  if(cart.size === 0) return;
  if(!validateForm()) return;

  const customer = {
    name: name.value.trim(),
    phone: phone.value.trim(),
    email: email.value.trim(),
    address: addr.value.trim()
  };
  const items = [...cart.values()].map(i => ({ sku: i.sku, qty: i.qty }));

  const res = await fetch(API, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ action: 'order', payload: { customer, items } })
  });
  const data = await res.json();
  if(data?.ok){
    // show confirmation page
    const confirm = document.getElementById('confirm');
    const msg = document.getElementById('confirmMsg');
    const tbl = document.getElementById('confirmTable');
    msg.textContent = `Order ${data.orderId} placed successfully. Total ${data.currency} ${Number(data.subtotal).toFixed(2)}.`;
    // build table from current cart snapshot
    let rows = ''; let total = 0;
    for(const it of cart.values()){
      const line = it.qty * it.price; total += line;
      rows += `<tr><td>${escapeHtml(it.sku)}</td><td>${escapeHtml(it.name)}</td><td style="text-align:right">${it.qty}</td><td style="text-align:right">${money(line)}</td></tr>`;
    }
    tbl.innerHTML = `<table>
      <thead><tr><th>SKU</th><th>Name</th><th>Qty</th><th>Line</th></tr></thead>
      <tbody>${rows}</tbody>
      <tfoot><tr><td colspan="3" style="text-align:right">Subtotal</td><td style="text-align:right">${money(total)}</td></tr></tfoot>
    </table>`;
    document.getElementById('cartBox').style.display = 'none';
    document.getElementById('items').innerHTML = '';
    document.getElementById('category').disabled = true;
    document.getElementById('search').disabled = true;
    confirm.classList.remove('hidden');
    cart.clear();
    document.getElementById('cartPill').style.display = 'none';
  } else {
    alert('Order failed: ' + (data?.error || 'Unknown error'));
  }
}

document.getElementById('category').addEventListener('change', renderProducts);
document.getElementById('search').addEventListener('input', renderProducts);
document.getElementById('placeOrder').addEventListener('click', placeOrder);
document.getElementById('clearCart').addEventListener('click', ()=>{ cart.clear(); renderCart(); });
document.getElementById('newOrder').addEventListener('click', ()=>{ location.reload(); });

loadInventory();
</script>
</body>
</html>
